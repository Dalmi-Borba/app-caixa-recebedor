<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Caixa ASM</title>
    <link rel="icon" type="image/png" sizes="512x512" href="assets/img/iasdfavicon.png">
    <link rel="stylesheet" href="css/input_valor.css">
</head>
<style>
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
    body { background-color: #f2f4f8; padding: 2rem; }
    .navbar { display: flex; justify-content: center; background-color: #fff; border: 2px solid #aaa; border-radius: 15px; margin-bottom: 2rem; padding: 1rem; gap: 4rem; }
    .navbar a { text-decoration: none; color: #333; font-weight: bold; }
    nav { background-color: #000; padding: 1rem; text-align: center; }
    nav a { color: #fff; margin: 0 1rem; text-decoration: none; font-weight: bold; }
    header { background-color: #000; height: 60px; }
    .section-top { padding: 3rem 1rem; text-align: center; }
    .section-top p { font-size: 1.6rem; font-weight: 500; }
    .section-top strong { color: green; }
    .center { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 1rem; }
    .center h5 { font-size: 1.2rem; margin-bottom: 1rem; }
    .center input { width: 100%; padding: 2px; font-size: 1rem; }
    .center button { width: 100%; max-width: 300px; padding: 12px; font-size: 1rem; background-color: #fff; color: #000; border: 2px solid #000; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
    .center button:hover { background-color: #000; color: #fff; border: 2px solid #fff; }
    fieldset { width: 300px; margin: 2px auto; border: 2px solid black; border-radius: 8px; padding: 10px; }
    select { width: 100%; padding: 2px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; }

  .valor-item {
    display: flex;
    align-items: center;       /* alinha verticalmente */
    gap: 6px;                  /* espaço entre elementos */
    margin-bottom: 6px;
  }
  .valor-item label {
    white-space: nowrap;       /* impede quebra */
  }
  .valor-item .remover {
    cursor: pointer;
    font-size: 1.2rem;
    color: red;                 /* ícone vermelho */
    margin-left: 6px;
  }
  .valor-item .remover:hover {
       filter: brightness(0.8);
  }
</style>
<body>
    <div class="navbar">
        <a class="nav-link active" href="/">Home</a>
        <a class="nav-link" href="/view">Solicitações</a>
        <a class="nav-link" href="/movimentos">Movimentos</a>
    </div>

    <section>
        <div class="center">
            <form onsubmit="send()" action="/" method="POST" enctype="multipart/form-data">
              <h3>Depósito, Transferência ou PIX</h3>

              <fieldset>
                  <legend>Comprovante | Extrato</legend>
                  <input class="" type="file" id="image" name="image" required>
              </fieldset>

              <fieldset>
                  <legend>Favorecido</legend>
                  <input class="" type="text" id="nome" placeholder="Nome" name="nome" required>
              </fieldset>

              <!-- REMOVIDO: Data de Recebimento global -->

              <fieldset>
                  <legend>Conta Bancaria Recebedora</legend>
                  <select name="conta" id="conta" required>
                      <% contas.forEach(item => { %>
                          <option value="<%= item.conta %>"><%= item.conta %></option>
                      <% }); %>
                  </select>
              </fieldset>

              <fieldset>
                  <legend>Tipo</legend>
                  <div style="display: flex; gap: 1rem;">
                      <input type="radio" id="mat" name="mat" value="mat" required>
                      <label for="mat">Material</label>
                      <input type="radio" id="ins" name="mat" value="ins">
                      <label for="ins">Inscrição</label>
                  </div>
              </fieldset>

              <fieldset>
                  <legend>Descrição</legend>
                  <select name="material" id="material" required>
                      <option value=""></option>
                      <% desc.forEach(item => { %>
                      <option value="<%= item.desc %>"><%= item.desc %></option>
                      <% }) %>
                  </select>
              </fieldset>

              <fieldset>
                  <legend>Departamento</legend>
                  <select name="depto" id="depto" required>
                    <option value=""></option>
                    <% depto.forEach(item => { %>
                    <option value="<%= item.nun_depto %> - <%= item.nome_depto %>"><%= item.nome_depto %></option>
                    <% }) %>
                  </select>
              </fieldset>

              <fieldset>
                  <label for="valor-total">Valor Total:</label>
                  <input style="width: 100px;" type="text" id="valor-total" readonly>
                  <br><br>

                  <legend>Valores e Datas de Recebimento</legend>
                  <div id="valores-container" style="width: 400px;">
                    <div class="valor-item">
                      <label>Valor</label>
                      <input style="width: 100px;" type="text" oninput="mascaraMoeda(event); atualizarHidden()" placeholder="Valor" class="valor-input" required>
                      <label>Data</label>
                      <input style="width: 150px;" type="date" class="data-input" oninput="atualizarHidden()" required>
                      <span class="remover" onclick="removerValor(this)">❎</span>
                    </div>
                  </div>

                  <a style="color: blue;" onclick="adicionarValor()">+ Adicionar</a>

                  <!-- Mantido: valores em string -->
                  <input type="hidden" id="valor-hidden" name="valor">
                  <!-- NOVO: datas em string (mesma ordem dos valores) -->
                  <input type="hidden" id="datas-hidden" name="date">
              </fieldset>

              <fieldset>
                  <legend>Observações</legend>
                  <textarea class="" id="obs" name="obs"></textarea>
              </fieldset>
              <br>
              <button class="btn btn-primary shadow d-block w-100" type="submit">Enviar</button>

              <input type="hidden" name="aprovacao" id="aprovacao" value="false">
              <input type="hidden" name="tipo" id="tipo" value="pessoa">
              <input type="hidden" name="flag" id="flag" value="Depósito, Transferência ou PIX">
          </form>
        </div>
    </section>

    <script>
      // Helpers
      function todayISO() {
        return new Date().toISOString().slice(0,10);
      }

      function maskCurrency(valor, locale = 'pt-BR', currency = 'BRL') {
        return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(valor);
      }

      function mascaraMoeda(event) {
        const onlyDigits = event.target.value
          .split("")
          .filter(s => /\d/.test(s))
          .join("")
          .padStart(3, "0");
        const digitsFloat = onlyDigits.slice(0, -2) + "." + onlyDigits.slice(-2);
        event.target.value = maskCurrency(digitsFloat);
      }

      // Cria novo bloco valor+data
      function adicionarValor() {
        const container = document.getElementById('valores-container');

        const div = document.createElement('div');
        div.classList.add('valor-item');

        div.innerHTML = `
          <label>Valor</label>
          <input style="width: 100px;" type="text" oninput="mascaraMoeda(event); atualizarHidden()" placeholder="Valor" class="valor-input" required>
          <label>Data</label>
          <input style="width: 150px;" type="date" class="data-input" oninput="atualizarHidden()" required>
          <span class="remover" onclick="removerValor(this)">❎</span>
        `;

        container.appendChild(div);

        // Pré-preenche a data com hoje
        const lastDate = div.querySelector('.data-input');
        lastDate.value = todayISO();

        atualizarHidden();
      }

      function removerValor(botao) {
        const container = document.getElementById('valores-container');
        if (container.children.length > 1) {
          botao.parentElement.remove();
          atualizarHidden();
        }
      }

      // Atualiza strings hidden e o total
      function atualizarHidden() {
        const valorInputs = Array.from(document.querySelectorAll('.valor-input'));
        const dataInputs  = Array.from(document.querySelectorAll('.data-input'));

        // Coleta valores formatados (como exibidos) e também soma
        const valoresFormatados = [];
        let soma = 0;

        valorInputs.forEach(input => {
          const v = (input.value || '').trim();
          if (v) {
            valoresFormatados.push(v);
            // normaliza: remove "R$", espaços, pontos de milhar e troca vírgula por ponto
            const num = Number(
              v.replace('R$', '')
               .replace(/\s/g, '')
               .replace(/\./g, '')
               .replace(',', '.')
            );
            if (!Number.isNaN(num)) soma += num;
          }
        });

        // Coleta datas no mesmo índice dos valores
        const datasFormatadas = dataInputs.map(d => (d.value || '').trim());

        // Grava nos hidden (mantém compatibilidade: valores em string)
        document.getElementById('valor-hidden').value = valoresFormatados.join('; ');
        document.getElementById('datas-hidden').value = datasFormatadas.join('; ');

        // Exibe o total (sem formatação pra manter seu padrão atual; se quiser, formata)
        document.getElementById('valor-total').value = soma.toFixed(2);
      }

      // Data padrão = hoje para o primeiro item
      (function init() {
        const firstDate = document.querySelector('.data-input');
        if (firstDate) firstDate.value = todayISO();
        atualizarHidden();
      })();
    </script>

    <%- include('./partials/auto_complete'); %>
    <%- include('./partials/script'); %>
</body>
</html>
